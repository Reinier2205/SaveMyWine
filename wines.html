<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Wines - SaveMyWines</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style/styledemo.css">
    <link rel="manifest" href="/manifest.webmanifest" />
</head>
<body>
    <!-- Skip to main content link for screen readers -->
    <a href="#main-content" class="skip-link">Skip to main content</a>
    
    <header class="header">
        <div class="container">
            <h1 class="logo">SaveMyWines</h1>
            <nav class="nav">
                <a href="index.html" class="nav-link">Home</a>
                <a href="wines.html" class="nav-link active">My Wines</a>
                <a href="scan.html" class="nav-link">Scan Wine</a>
                <a href="about.html" class="nav-link">About</a>
            </nav>
        </div>
    </header>
    <main class="main" id="main-content">
        <div class="container">
            <!-- Hero Section -->
            <section class="hero-section">
                <h1 class="heading-1">My Wine Collection</h1>
                <p class="body">Track your wines, monitor aging, and never miss the perfect drinking window.</p>
            </section>

            <!-- Filter Section -->
            <section class="filter-section mb-6">
                <div class="card p-6">
                    <div class="flex items-center gap-4">
                        <div class="flex-1">
                            <input 
                                id="filter" 
                                class="bg-input border border-input-border text-main placeholder-muted text-base w-full p-3 rounded-lg" 
                                placeholder="Filter by varietal or vintage"
                            >
                        </div>
                        <a href="scan.html" class="btn btn-primary">
                            Add New Wine
                        </a>
                    </div>
                </div>
            </section>

            <!-- Export/Import Section -->
            <section class="export-import-section mb-6">
                <div class="card p-6">
                    <h3 class="heading-3 mb-4">Export & Import</h3>
                    <div class="flex items-center gap-4 flex-wrap">
                        <button id="exportJson" class="btn btn-secondary" aria-label="Export wine collection as JSON file">
                            Export JSON
                        </button>
                        <button id="exportCsv" class="btn btn-accent" aria-label="Export wine collection as CSV file">
                            Export CSV
                        </button>
                        <div class="flex-1 min-w-64">
                            <label for="importFile" class="sr-only">Import wine collection from JSON file</label>
                            <input 
                                id="importFile" 
                                class="bg-input border border-input-border text-main placeholder-muted text-base w-full p-3 rounded-lg" 
                                type="file" 
                                accept=".json"
                                aria-label="Choose JSON file to import wine collection"
                            >
                        </div>
                    </div>
                    <p class="body-sm text-muted mt-3">
                        Export your wine collection or import wines from a JSON file. Import functionality is preview-only in this MVP.
                    </p>
                </div>
            </section>

            <!-- Wines Grid -->
            <section class="wines-section">
                <div id="grid" class="wines-grid">
                    <!-- Wine cards will be populated by JavaScript -->
                </div>
                
                <!-- Loading State -->
                <div id="loading" class="text-center p-8">
                    <p class="body text-muted">Loading your wine collection...</p>
                </div>
                
                <!-- Empty State -->
                <div id="empty" class="text-center p-8 hidden">
                    <div class="card p-8 max-w-md mx-auto">
                        <h3 class="heading-3 mb-4">No Wines Yet</h3>
                        <p class="body mb-6">Start building your collection by scanning your first wine label.</p>
                        <a href="scan.html" class="btn btn-primary">Scan Wine</a>
                    </div>
                </div>
            </section>
        </div>
    </main>
    <footer class="footer">
        <div class="container">
            <p>&copy; 2024 SaveMyWines. All rights reserved.</p>
        </div>
    </footer>
    
    <script type="module">
        import { listWines } from "./scripts/storage.js";
        import { yearsAndMonthsSince } from "./scripts/utils.js";
        
        const grid = document.getElementById('grid');
        const loading = document.getElementById('loading');
        const empty = document.getElementById('empty');
        let wines = [];
        
        // Download utility function
        function download(name, text) {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([text], { type: 'text/plain' }));
            a.download = name;
            a.click();
        }
        
        // Export JSON functionality
        document.getElementById('exportJson').onclick = () => {
            if (wines.length === 0) {
                alert('No wines to export. Add some wines first!');
                return;
            }
            download("wines.json", JSON.stringify(wines, null, 2));
        };
        
        // Export CSV functionality
        document.getElementById('exportCsv').onclick = () => {
            if (wines.length === 0) {
                alert('No wines to export. Add some wines first!');
                return;
            }
            const rows = [["name","producer","varietal","vintage","date_purchased","best_drink_date","notes","label_image_url"]];
            wines.forEach(w => rows.push([
                w.name, 
                w.producer, 
                w.varietal, 
                w.vintage, 
                w.date_purchased, 
                w.best_drink_date, 
                w.notes, 
                w.label_image_url
            ]));
            const csvContent = rows.map(r => 
                r.map(x => `"${(x ?? '').toString().replace(/"/g, '""')}"`).join(",")
            ).join("\n");
            download("wines.csv", csvContent);
        };
        
        // Import functionality
        document.getElementById('importFile').onchange = async (e) => {
            const file = e.target.files?.[0];
            if (!file) return;
            
            try {
                const text = await file.text();
                const arr = JSON.parse(text);
                
                if (!Array.isArray(arr)) {
                    alert('Invalid file format. Expected JSON array of wines.');
                    return;
                }
                
                // Validate wine data structure
                const validWines = arr.filter(w => w.name && w.date_purchased);
                const invalidCount = arr.length - validWines.length;
                
                let message = `Imported ${arr.length} wines`;
                if (invalidCount > 0) {
                    message += ` (${invalidCount} invalid entries skipped)`;
                }
                message += '.\n\nThis is preview-only in MVP. Full import functionality will be implemented in the next step.';
                
                alert(message);
                
                // Clear the file input
                e.target.value = '';
                
            } catch (error) {
                console.error('Import error:', error);
                alert('Error reading file. Please ensure it\'s a valid JSON file.');
                e.target.value = '';
            }
        };
        
        // Paint wines to grid
        const paint = (arr) => { 
            if (arr.length === 0) {
                grid.classList.add('hidden');
                empty.classList.remove('hidden');
                return;
            }
            
            grid.classList.remove('hidden');
            empty.classList.add('hidden');
            
            grid.innerHTML = arr.map(w => {
                const age = yearsAndMonthsSince(w.date_purchased);
                const due = w.best_drink_date && new Date(w.best_drink_date) - new Date() < 31557600000; // < 1y
                
                return `
                    <div class="card p-6">
                        <img src="${w.label_image_url || ''}" alt="Wine Label" class="wine-image">
                        <h3 class="heading-3 mb-3">
                            ${w.name} 
                            <span class="tag">${w.varietal || ''}</span>
                        </h3>
                        <div class="body mb-2">
                            Vintage: ${w.vintage || '-'} | Purchased: ${w.date_purchased} (${age.years}y ${age.months}m)
                        </div>
                        <div class="body mb-4">
                            Best drink: ${w.best_drink_date || '-'} 
                            ${due ? '<span class="tag tag-accent">Soon</span>' : ''}
                        </div>
                        ${w.notes ? `<div class="body-sm text-muted mb-4">${w.notes}</div>` : ''}
                        <div class="flex gap-2">
                            <button class="btn btn-secondary" onclick="editWine('${w.id}')" aria-label="Edit wine details">Edit</button>
                            <button class="btn btn-secondary" onclick="deleteWine('${w.id}')" aria-label="Delete wine from collection">Delete</button>
                        </div>
                    </div>`;
            }).join(''); 
        };
        
        // Load and display wines
        const loadWines = async () => {
            try {
                loading.classList.remove('hidden');
                grid.classList.add('hidden');
                empty.classList.add('hidden');
                
                wines = await listWines();
                paint(wines);
                
            } catch (error) {
                console.error('Error loading wines:', error);
                grid.innerHTML = `
                    <div class="card p-6 text-center">
                        <p class="body text-muted">Error loading wines. Please try again.</p>
                    </div>
                `;
            } finally {
                loading.classList.add('hidden');
            }
        };
        
        // Filter wines
        document.getElementById('filter').oninput = (e) => {
            const q = e.target.value.toLowerCase().trim();
            if (!q) {
                paint(wines);
            } else {
                const filtered = wines.filter(w =>
                    (w.varietal || '').toLowerCase().includes(q) ||
                    String(w.vintage || '').includes(q) ||
                    (w.name || '').toLowerCase().includes(q) ||
                    (w.producer || '').toLowerCase().includes(q)
                );
                paint(filtered);
            }
        };
        
        // Placeholder functions for future implementation
        window.editWine = (wineId) => {
            console.log('Edit wine:', wineId);
            alert('Edit functionality will be implemented in the next step');
        };
        
        window.deleteWine = (wineId) => {
            console.log('Delete wine:', wineId);
            if (confirm('Are you sure you want to delete this wine?')) {
                alert('Delete functionality will be implemented in the next step');
            }
        };
        
        // Initialize page
        loadWines();
    </script>
    
    <script src="scripts/wines.js"></script>
    <script>
        if('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(registration => {
                    console.log('Service Worker registered successfully:', registration);
                })
                .catch(error => {
                    console.error('Service Worker registration failed:', error);
                });
        }
    </script>
</body>
</html>
